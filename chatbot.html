<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LongCat AI Assistant</title>
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #212121; color: #ececec; margin: 0; }
        
        .sidebar { 
            background-color: #171717; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                width: 280px;
            }
            .sidebar.open { transform: translateX(0); }
        }

        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
        }
        .overlay.active { display: block; }

        .glass-panel { background: rgba(47, 47, 47, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .user-msg { background-color: #2f2f2f; border-radius: 1.25rem; padding: 0.75rem 1rem; max-width: 85%; align-self: flex-end; }
        .assistant-row { align-self: flex-start; max-width: 95%; width: 100%; }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #3c3c3c; border-radius: 10px; }
        
        .copy-btn { opacity: 0; transition: all 0.2s ease; }
        .assistant-row:hover .copy-btn { opacity: 1; }
        
        @keyframes loading { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .dot-loader { animation: loading 1.2s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Mobile Header -->
    <header class="md:hidden flex items-center justify-between p-4 border-b border-white/10 bg-[#212121] z-30">
        <button onclick="openSidebar()"><i class="fa-solid fa-bars text-xl"></i></button>
        <span class="font-bold text-sm tracking-tight">LongCat AI</span>
        <button onclick="toggleSettings()"><i class="fa-solid fa-cog text-xl text-white/50"></i></button>
    </header>

    <!-- Mobile Backdrop Overlay -->
    <div id="overlay" class="overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar h-full flex flex-col border-r border-white/10 shrink-0">
        <div class="p-4 flex flex-col h-full">
            <div class="md:hidden flex justify-end mb-2">
                <button onclick="closeSidebar()" class="p-2 text-white/50 hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <button onclick="newChat()" class="flex items-center gap-3 w-full p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition text-sm font-medium mb-6">
                <i class="fa-solid fa-plus"></i> New Chat
            </button>

            <div id="chat-list" class="flex-grow overflow-y-auto space-y-2 text-sm text-white/60 text-center opacity-20 italic text-xs pt-4">
                No history yet
            </div>

            <div class="pt-4 border-t border-white/10">
                <button onclick="toggleSettings()" class="flex items-center gap-3 w-full p-3 rounded-xl hover:bg-white/5 transition text-sm">
                    <i class="fa-solid fa-key opacity-50"></i> API Settings
                </button>
            </div>
        </div>
    </aside>

    <!-- Main App Area -->
    <main class="flex-grow flex flex-col h-full relative">
        <div id="feed" class="flex-grow overflow-y-auto p-4 md:p-8 space-y-8 flex flex-col max-w-4xl mx-auto w-full">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-30">
                <div class="w-20 h-20 rounded-3xl bg-white/5 flex items-center justify-center border border-white/10">
                    <i class="fa-solid fa-cat text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold">Ready to help</h1>
                <p class="max-w-xs text-sm">Set your API key and start managing your daily tasks.</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="p-4 md:pb-8 bg-[#212121]">
            <div class="max-w-3xl mx-auto relative">
                <div class="glass-panel rounded-2xl p-2 flex items-end gap-2 focus-within:ring-1 focus-within:ring-white/30 shadow-2xl transition-all">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message LongCat..." 
                        class="flex-grow bg-transparent border-none focus:ring-0 p-3 resize-none max-h-48 text-base outline-none"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    
                    <!-- Toggleable Send/Stop Button -->
                    <button 
                        id="action-btn" 
                        onclick="handleAction()" 
                        class="bg-white text-black w-10 h-10 rounded-xl flex items-center justify-center hover:scale-105 active:scale-95 transition shrink-0">
                        <i id="action-icon" class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
                <p id="error-box" class="text-[11px] text-red-400 mt-2 text-center hidden"></p>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden p-4">
        <div class="bg-[#2f2f2f] w-full max-w-md rounded-2xl p-6 border border-white/10 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="toggleSettings()"><i class="fa-solid fa-times text-white/50 hover:text-white"></i></button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-bold uppercase text-white/40 mb-1 block">API Key</label>
                    <input id="key-input" type="password" placeholder="Enter LongCat API Key" class="w-full bg-black/20 border border-white/10 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                </div>
                <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl space-y-2">
                    <p class="text-[11px] text-blue-300 font-bold uppercase">CORS Whitelist</p>
                    <div class="flex items-center gap-2 bg-black/40 p-2 rounded border border-white/10">
                        <code id="display-domain" class="text-[10px] flex-grow truncate text-blue-400">Detecting...</code>
                        <button onclick="copyToClip(document.getElementById('display-domain').innerText)" class="text-blue-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                    </div>
                </div>
                <button onclick="saveKey()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-500 transition">Save Settings</button>
            </div>
        </div>
    </div>

    <textarea id="hidden-copy" class="fixed -top-full opacity-0"></textarea>

    <script>
        let messages = [];
        let isProcessing = false;
        let currentAbortController = null;

        window.onload = () => {
            const savedKey = localStorage.getItem('lc_key');
            if (savedKey) document.getElementById('key-input').value = savedKey;
            const currentOrigin = window.location.origin;
            document.getElementById('display-domain').innerText = (currentOrigin === 'null' || !currentOrigin) ? "Local File" : currentOrigin;
        };

        function handleAction() {
            if (isProcessing) {
                stopResponse();
            } else {
                handleSend();
            }
        }

        function stopResponse() {
            if (currentAbortController) {
                currentAbortController.abort();
                isProcessing = false;
                updateActionBtnState(false);
                notify("Response Stopped");
            }
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function saveKey() {
            const key = document.getElementById('key-input').value.trim();
            localStorage.setItem('lc_key', key);
            toggleSettings();
            notify("Settings Saved");
        }

        function updateActionBtnState(processing) {
            const icon = document.getElementById('action-icon');
            const btn = document.getElementById('action-btn');
            if (processing) {
                icon.className = "fa-solid fa-square text-xs"; // Stop icon
                btn.classList.add('bg-white/20');
            } else {
                icon.className = "fa-solid fa-arrow-up"; // Send icon
                btn.classList.remove('bg-white/20');
            }
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const errorBox = document.getElementById('error-box');
            const text = input.value.trim();
            const apiKey = localStorage.getItem('lc_key');

            if (!text || isProcessing) return;
            if (!apiKey) {
                errorBox.innerText = "Please enter an API Key in settings.";
                errorBox.classList.remove('hidden');
                toggleSettings();
                return;
            }

            errorBox.classList.add('hidden');
            document.getElementById('empty-state')?.remove();
            
            appendUIMessage('user', text);
            input.value = '';
            input.style.height = 'auto';
            
            isProcessing = true;
            updateActionBtnState(true);
            currentAbortController = new AbortController();

            const aiMsgId = appendUIMessage('assistant', '<span class="dot-loader">Thinking...</span>');
            
            try {
                const response = await fetch("https://api.longcat.chat/openai/v1/chat/completions", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    signal: currentAbortController.signal,
                    body: JSON.stringify({
                        model: "LongCat-Flash-Chat",
                        messages: messages,
                        stream: false
                    })
                });

                if (!response.ok) throw new Error(`Status: ${response.status}`);

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                updateUIMessage(aiMsgId, content);
                messages.push({ role: 'assistant', content });

            } catch (err) {
                if (err.name === 'AbortError') {
                    updateUIMessage(aiMsgId, `<span class="text-white/30 italic text-xs">Response stopped by user.</span>`);
                } else {
                    updateUIMessage(aiMsgId, `<div class="p-3 bg-red-500/10 border border-red-500/20 text-red-400 text-xs rounded-lg">${err.message}</div>`);
                }
            } finally {
                isProcessing = false;
                updateActionBtnState(false);
                currentAbortController = null;
            }
        }

        function appendUIMessage(role, content) {
            const feed = document.getElementById('feed');
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.className = role === 'user' ? 'user-msg' : 'assistant-row';
            
            if (role === 'user') {
                div.innerHTML = `<p class="text-sm leading-relaxed">${content}</p>`;
            } else {
                div.innerHTML = `
                    <div class="flex gap-4 group">
                        <div class="w-8 h-8 rounded-full bg-blue-600 shrink-0 flex items-center justify-center border border-white/10 shadow-lg"><i class="fa-solid fa-cat text-[12px] text-white"></i></div>
                        <div class="flex flex-col gap-2 flex-grow overflow-hidden">
                            <div id="${id}" class="text-sm leading-relaxed whitespace-pre-wrap font-medium">${content}</div>
                            <div class="flex items-center gap-2 mt-2">
                                <button onclick="copyToClip(document.getElementById('${id}').innerText)" class="copy-btn flex items-center gap-1.5 text-[10px] text-white/40 hover:text-white px-2 py-1 bg-white/5 rounded border border-white/5 transition">
                                    <i class="fa-regular fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>`;
            }

            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
            if (role === 'user') messages.push({ role, content });
            return id;
        }

        function updateUIMessage(id, content) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = content;
            document.getElementById('feed').scrollTop = document.getElementById('feed').scrollHeight;
        }

        function copyToClip(text) {
            const h = document.getElementById('hidden-copy');
            h.value = text; h.select();
            document.execCommand('copy');
            notify("Copied");
        }

        function notify(text) {
            const t = document.createElement('div');
            t.className = "fixed bottom-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-5 py-2 rounded-full text-xs font-bold shadow-2xl z-[200] animate-bounce";
            t.innerText = text;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        document.getElementById('user-input').onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAction(); }
        };
        function newChat() { location.reload(); }
    </script>
</body>
</html>

